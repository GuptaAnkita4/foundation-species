ggplot() +
# POINTS (observed; already on log scale)
# geom_jitter(
#   data = obs_data,
#   aes(x = logArea, y = .data[[yvar_logcol]], shape = point_group, fill = point_group),
#   width = 0.1, alpha = 0.4, size = 2, stroke = 0.4, color = "black"
# ) +
# # LINES (predicted; log of the mean)
geom_line(
data = pred_data,
aes(x = x, y = tlog_line(predicted), color = line_group, group = line_group),
linewidth = 1, inherit.aes = FALSE
) +
annotate("text",
x = min(obs_data$logArea, na.rm = TRUE) + 0.5,
y = min(ylims, na.rm = TRUE) + 0.95 * diff(range(ylims, na.rm = TRUE)),
label = annotation_text, size = 4, hjust = 0
) +
# --- CI ribbon (response -> log for plotting)
# geom_ribbon(
#   data = pred_data,
#   aes(x = x,
#       ymin = tlog_line(lower),
#       ymax = tlog_line(upper),
#       fill = line_group,
#       group = line_group),
#   alpha = 0.18,
#   inherit.aes = FALSE
# ) +
#  scale_shape_manual(values = shape_vals, labels = wv_labels, name = "Points: % Wetland Vegetation") +
#  scale_fill_manual(values = fill_vals,  labels = wv_labels, name = "Points: % Wetland Vegetation") +
scale_color_manual(values = line_vals, labels = wv_labels, name = "% Wetland Vegetation") +
labs(title = season_label, x = "log2(Wetland Area)", y = ylab_text) +
scale_x_continuous(limits = xlims) +
scale_y_continuous(limits = ylims) +
theme_bw(base_size = 12) +
theme(
panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
axis.title = element_text(size = 14),
axis.text  = element_text(size = 14),
legend.position = "bottom",
legend.title = element_text(size = 12),
legend.text  = element_text(size = 12)
) +
guides(
color = guide_legend(override.aes = list(linewidth = 2), order = 1),
fill  = guide_legend(override.aes = list(size = 2), order = 2),
shape = guide_legend(override.aes = list(size = 2), order = 2)
)
}
# axis limits using log(y) (safe via +epsilon in normalize_glm_dat)
xlim_rich  <- range(c(s.glm.dat$logArea, w.glm.dat$logArea), na.rm = TRUE)
ylim_rich  <- range(c(s.glm.dat$log_rich, w.glm.dat$log_rich), na.rm = TRUE)
xlim_abund <- xlim_rich
ylim_abund <- range(c(s.glm.dat$log_abun, w.glm.dat$log_abun), na.rm = TRUE)
p_a <- make_wv_plot(pred_rich_s,  s.glm.dat, "Summer", "log_rich", lab_rich_s,  "log(Richness)",  xlim_rich,  ylim_rich)
p_b <- make_wv_plot(pred_rich_w,  w.glm.dat, "Winter", "log_rich", lab_rich_w,  "log(Richness)",  xlim_rich,  ylim_rich) + labs(y = NULL)
p_c <- make_wv_plot(pred_count_s, s.glm.dat, "Summer", "log_abun", lab_count_s, "log(Abundance)", xlim_abund, ylim_abund)
p_d <- make_wv_plot(pred_count_w, w.glm.dat, "Winter", "log_abun", lab_count_w, "log(Abundance)", xlim_abund, ylim_abund) + labs(y = NULL)
combined_plot <- (
(p_a + p_b + plot_spacer() + p_c + p_d) +
plot_layout(ncol = 5, widths = c(1, 1, 0.05, 1, 1), guides = "collect") +
plot_annotation(tag_levels = "a") &
theme(
legend.position = "bottom",
legend.title = element_text(size = 12),
legend.text  = element_text(size = 12)
) &
guides(
color = guide_legend(nrow = 1),
fill  = guide_legend(nrow = 1),
shape = guide_legend(nrow = 1)
)
)
# Save outputs
ggsave(here("Figures", "SAR_WV_combined_color.png"), combined_plot, width = 14, height = 5, dpi = 600)
combined_plot
# Load required libraries
pacman::p_load(
ggplot2, dplyr, readr, sars, cowplot, glmmTMB, patchwork,
here, fs
)
# ---- Analyzing Winter Species-Area Relationships ----
# Winter
w.sar <- sar_power(as.matrix(w.sparea[, c("aT", "s")]))  # SAR
w.aar <- sar_power(as.matrix(w.sparea[, c("aT", "a")]))  # AAR
summary(w.sar)
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
summary(s.sar)
# ---- Analyzing Summer Species-Area Relationships ----
# Summer
s.sar <- sar_power(as.matrix(s.sparea[, c("aT", "s")]))
s.aar <- sar_power(as.matrix(s.sparea[, c("aT", "a")]))
summary(s.sar)
summary(s.aar)
summary(w.sar)
summary(w.aar)
# ---- Analyzing Winter Species-Area Relationships ----
# Winter
w.sar <- sar_power(as.matrix(w.sparea[, c("aT", "s")]))  # SAR
w.aar <- sar_power(as.matrix(w.sparea[, c("aT", "a")]))  # AAR
summary(w.sar)
summary(w.aar)
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
source("~/GitHub/foundation-species/scripts/02_SAR_AAR.R")
summary(s.sar)
# ---- Fit SAR/AAR with sars::sar_power on RAW scale ----
w.sar <- sar_power(as.matrix(w.sparea[, c("aT", "s")]))  # SAR
w.aar <- sar_power(as.matrix(w.sparea[, c("aT", "a")]))  # AAR
s.sar <- sar_power(as.matrix(s.sparea[, c("aT", "s")]))
s.aar <- sar_power(as.matrix(s.sparea[, c("aT", "a")]))
summary(s.sar)
summary(w.sar)
summary(s.aar)
summary(w.aar)
# scripts/10_analysis_wv_interactions.R
suppressPackageStartupMessages({
library(here)
library(pacman)
})
pacman::p_load(
dplyr, ggplot2, readr, glmmTMB, ggeffects, emmeans, car, DHARMa,
patchwork, GGally, cowplot, sars
)
dir.create(here("Figures"), showWarnings = FALSE)
# ---- global epsilons for safe log on observed counts -----------------
EPS_RICH <- 0.5     # half-count for richness
EPS_ABUN <- 0.5     # half-count for abundance
tlog_point_rich <- function(y) log(pmax(y, EPS_RICH))
tlog_point_abun <- function(y) log(pmax(y, EPS_ABUN))
tlog_line       <- function(mu) log(mu)   # predictions (no epsilon)
# Ensure WVclass factor order and build log columns for plotting (pure log)
normalize_glm_dat <- function(df) {
stopifnot(all(c("grid","logArea","perWV","WVclass","richness","abundance") %in% names(df)))
df %>%
mutate(
WVclass  = factor(as.character(WVclass), levels = c("0","1","2")),
log_rich = tlog_point_rich(richness),
log_abun = tlog_point_abun(abundance)
)
}
s.glm.dat <- normalize_glm_dat(s.glm.dat)
w.glm.dat <- normalize_glm_dat(w.glm.dat)
# quick pairplot (optional)
pairplot <- GGally::ggpairs(s.glm.dat[, c("logArea", "perWV", "richness", "abundance")])
ggsave(here("Figures", "pairplot_summer.png"), pairplot, width = 8, height = 6, dpi = 300)
# ---------------------- Modeling helpers ------------------------------------
fit_nb <- function(df, response) {
form_full <- as.formula(paste0(response, " ~ logArea*factor(WVclass) + (1|grid)"))
glmmTMB::glmmTMB(
form_full, data = df, family = nbinom2,
control = glmmTMBControl(optimizer = optim, optArgs = list(method = "BFGS")),
na.action = na.fail
)
}
predict_grid <- function(mod, df, term_name = "logArea") {
stopifnot(term_name %in% names(df), "WVclass" %in% names(df), "grid" %in% names(df))
xs     <- seq(min(df[[term_name]], na.rm = TRUE),
max(df[[term_name]], na.rm = TRUE), length.out = 100)
groups <- levels(factor(df$WVclass, levels = c("0","1","2")))
newdata <- expand.grid(logArea = xs, WVclass = groups, KEEP.OUT.ATTRS = FALSE)
# dummy RE to exclude random effects
newdata$grid <- df$grid[1]
# predict on LINK scale, then transform (NB uses log link by default)
pr_link <- predict(mod, newdata = newdata, type = "link", se.fit = TRUE, re.form = NA)
eta  <- as.numeric(pr_link$fit)
se   <- as.numeric(pr_link$se.fit)
mu      <- exp(eta)
mu_low  <- exp(eta - 1.96 * se)
mu_high <- exp(eta + 1.96 * se)
data.frame(
x         = newdata[[term_name]],
predicted = mu,
lower     = mu_low,
upper     = mu_high,
group     = factor(newdata$WVclass, levels = c("0","1","2"))
)
}
anova_sig_label <- function(mod) {
a <- car::Anova(mod, type = "III")
rn <- rownames(a); term <- which(grepl("logArea:factor\\(WVclass\\)", rn))
p <- if (length(term)) a$`Pr(>Chisq)`[term] else NA_real_
if (is.na(p)) "p = NA" else if (p < 0.001) "p < 0.001" else if (p < 0.01) "p < 0.01" else if (p < 0.05) "p < 0.05" else "p > 0.05"
}
diag_dharma <- function(mod, tag) {
sim <- DHARMa::simulateResiduals(mod)
plot(sim)
ggplot2::ggsave(here("Figures", paste0("dharma_", tag, ".png")), width = 7, height = 5, dpi = 300)
invisible(sim)
}
# ---------------------- Fit models ------------------------------------------
# Summer
s_nb_rich  <- fit_nb(s.glm.dat, "richness");  print(summary(s_nb_rich));  print(Anova(s_nb_rich, type = "III"))
s_nb_count <- fit_nb(s.glm.dat, "abundance"); print(summary(s_nb_count)); print(Anova(s_nb_count, type = "III"))
lab_rich_s  <- anova_sig_label(s_nb_rich)
lab_count_s <- anova_sig_label(s_nb_count)
# Winter
w_nb_rich  <- fit_nb(w.glm.dat, "richness");  print(summary(w_nb_rich));  print(Anova(w_nb_rich, type = "III"))
w_nb_count <- fit_nb(w.glm.dat, "abundance"); print(summary(w_nb_count)); print(Anova(w_nb_count, type = "III"))
lab_rich_w  <- anova_sig_label(w_nb_rich)
lab_count_w <- anova_sig_label(w_nb_count)
lab_rich_s
car::Anova(s_nb_rich, type = "III")
> car::Anova(s_nb_count, type = "III")
car::Anova(s_nb_count, type = "III")
car::Anova(w_nb_rich, type = "III")
car::Anova(w_nb_count, type = "III")
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
ggplot() +
# POINTS (observed; already on log scale)
# geom_jitter(
#   data = obs_data,
#   aes(x = logArea, y = .data[[yvar_logcol]], shape = point_group, fill = point_group),
#   width = 0.1, alpha = 0.4, size = 2, stroke = 0.4, color = "black"
# ) +
# # LINES (predicted; log of the mean)
geom_line(
data = pred_data,
aes(x = x, y = tlog_line(predicted), color = line_group, group = line_group),
linewidth = 1, inherit.aes = FALSE
) +
annotate("text",
x = min(obs_data$logArea, na.rm = TRUE) + 0.5,
y = min(ylims, na.rm = TRUE) + 0.95 * diff(range(ylims, na.rm = TRUE)),
label = annotation_text, size = 4, hjust = 0
) +
# --- CI ribbon (response -> log for plotting)
# geom_ribbon(
#   data = pred_data,
#   aes(x = x,
#       ymin = tlog_line(lower),
#       ymax = tlog_line(upper),
#       fill = line_group,
#       group = line_group),
#   alpha = 0.18,
#   inherit.aes = FALSE
# ) +
#  scale_shape_manual(values = shape_vals, labels = wv_labels, name = "Points: % Wetland Vegetation") +
#  scale_fill_manual(values = fill_vals,  labels = wv_labels, name = "Points: % Wetland Vegetation") +
scale_color_manual(values = line_vals, labels = wv_labels, name = "% Wetland Vegetation") +
labs(title = season_label, x = "log2(Wetland Area)", y = ylab_text) +
scale_x_continuous(limits = xlims) +
scale_y_continuous(limits = ylims) +
theme_bw(base_size = 12) +
theme(
panel.grid = element_blank(),
plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
axis.title = element_text(size = 14),
axis.text  = element_text(size = 14),
legend.position = "bottom",
legend.title = element_text(size = 12),
legend.text  = element_text(size = 12)
) +
guides(
color = guide_legend(override.aes = list(linewidth = 2), order = 1),
fill  = guide_legend(override.aes = list(size = 2), order = 2),
shape = guide_legend(override.aes = list(size = 2), order = 2)
)
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
source("~/GitHub/foundation-species/scripts/05_fseffects_areaclass.R")
print(list(lab_s_ric, lab_s_ab, lab_w_ric, lab_w_ab))
source("~/GitHub/foundation-species/scripts/05_fseffects_areaclass.R")
one_row_ci <- (q1 + q3 + plot_spacer() + q2 + q4) +
plot_layout(ncol = 5, widths = c(1, 1, 0.05, 1, 1), guides = "collect") &
theme(
legend.position = "bottom",
legend.title = element_text(size = 10),
legend.text  = element_text(size = 9)
)
ggsave(here::here("Figures", "hotspots_ci_row.png"),
one_row_ci, width = 14, height = 5, dpi = 600)
print(one_row_ci)
q1 <- plot_line_sd_metric(line_summary_sd, "Richness",  "Summer", lab_s_ric) + ylim(range_ric_ci) + labs(tag = "a") + tag_theme
q2 <- plot_line_sd_metric(line_summary_sd, "Abundance","Summer", lab_s_ab ) + ylim(range_ab_ci ) + labs(tag = "c") + tag_theme
q3 <- plot_line_sd_metric(line_summary_sd, "Richness",  "Winter",  lab_w_ric) + ylim(range_ric_ci) + labs(tag = "b") + tag_theme + labs(y = NULL)
q4 <- plot_line_sd_metric(line_summary_sd, "Abundance","Winter",  lab_w_ab ) + ylim(range_ab_ci ) + labs(tag = "d") + tag_theme  +labs(y = NULL)
one_row_ci <- (q1 + q3 + plot_spacer() + q2 + q4) +
plot_layout(ncol = 5, widths = c(1, 1, 0.05, 1, 1), guides = "collect") &
theme(
legend.position = "bottom",
legend.title = element_text(size = 10),
legend.text  = element_text(size = 9)
)
ggsave(here::here("Figures", "hotspots_ci_row.png"),
one_row_ci, width = 14, height = 5, dpi = 600)
print(one_row_ci)
summary(s.mod_hotspot.ric)
summary(s.mod_hotspot.ab)
summary(w.mod_hotspot.ric)
summary(w.mod_hotspot.ab)
aov_s_ric
aov_s_av
aov_s_ab
aov_w_ric
aov_w_ab
source("~/GitHub/foundation-species/scripts/04_area-trophic-interaction.R")
summary(troph_rich_A.s)
summary(troph_rich_A.w)
summary(troph_count_A.s)
summary(troph_count_A.w)
source("~/GitHub/foundation-species/scripts/04_area-trophic-interaction.R")
source("~/GitHub/foundation-species/scripts/04_area-trophic-interaction.R")
p_a
source("~/GitHub/foundation-species/scripts/03_species-area-foundationspecies-models.R")
source("~/GitHub/foundation-species/scripts/04_area-trophic-interaction.R")
richWVtroph.s
# ---------------------------------------------------------------------
# Plots (AREA × trophic level): 2×2 (Summer/Winter × Richness/Abundance)
# ---------------------------------------------------------------------
richWVtroph.s <- ggplot(pred_rich_A.s, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(
data = data.frame(x = -Inf, y = Inf, lab = lab_rich_s),
aes(x = x, y = y, label = lab),
inherit.aes = FALSE, hjust = -0.05, vjust = 1.2, size = 3.5
) +
# geom_point(data = s.sparea.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Summer", x = expression(log[2]("Wetland Area")), y = y_lab_rich, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophrich_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_rich) + scale_y_continuous(limits = ylim_rich) +
custom_theme + labs(tag = "a") + tag_theme
richWVtroph.s
# ---------------------------------------------------------------------
# Plots (AREA × trophic level): 2×2 (Summer/Winter × Richness/Abundance)
# ---------------------------------------------------------------------
richWVtroph.s <- ggplot(pred_rich_A.s, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(
data = data.frame(x = -Inf, y = Inf, lab = lab_rich_s),
aes(x = x, y = y, label = lab),
inherit.aes = FALSE, hjust = -0.05, vjust = 2.2, size = 3.5
) +
# geom_point(data = s.sparea.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Summer", x = expression(log[2]("Wetland Area")), y = y_lab_rich, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophrich_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_rich) + scale_y_continuous(limits = ylim_rich) +
custom_theme + labs(tag = "a") + tag_theme
richWVtroph.s
# ---------------------------------------------------------------------
# Plots (AREA × trophic level): 2×2 (Summer/Winter × Richness/Abundance)
# ---------------------------------------------------------------------
richWVtroph.s <- ggplot(pred_rich_A.s, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(
data = data.frame(x = -Inf, y = Inf, lab = lab_rich_s),
aes(x = x, y = y, label = lab),
inherit.aes = FALSE, hjust = -0.05, vjust = 2.2, size = 3.5
) +
# geom_point(data = s.sparea.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Summer", x = expression(log[2]("Wetland Area")), y = y_lab_rich, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophrich_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_rich) + scale_y_continuous(limits = ylim_rich) +
custom_theme + labs(tag = "a") + tag_theme
richWVtroph.w <- ggplot(pred_rich_A.w, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(data = data.frame(x = -Inf, y = Inf, lab = lab_rich_w),
aes(x = x, y = y, label = lab), inherit.aes = FALSE,
hjust = -0.05, vjust = 2.2, size = 3.5) +
# geom_point(data = w.sparea.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Winter", x = expression(log[2]("Wetland Area")), y = NULL, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophrich_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_rich) + scale_y_continuous(limits = ylim_rich) +
custom_theme+ labs(tag = "b") + tag_theme
countWVtroph.s <- ggplot(pred_count_A.s, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(data = data.frame(x = -Inf, y = Inf, lab = lab_cnt_s),
aes(x = x, y = y, label = lab), inherit.aes = FALSE,
hjust = -0.05, vjust = 2.2, size = 3.5) +
# geom_point(data = s.spcount.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Summer", x = expression(log[2]("Wetland Area")), y = y_lab_abund, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophcount_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_abund) + scale_y_continuous(limits = ylim_abund) +
custom_theme+ labs(tag = "c") + tag_theme
countWVtroph.w <- ggplot(pred_count_A.w, aes(x = x, y = tlog_line(predicted), color = group)) +
geom_text(data = data.frame(x = -Inf, y = Inf, lab = lab_cnt_w),
aes(x = x, y = y, label = lab), inherit.aes = FALSE,
hjust = -0.05, vjust = 2.2, size = 3.5) +
# geom_point(data = w.spcount.troph, aes(x = logArea, y = y_plot, color = group),
#            inherit.aes = FALSE, alpha = 0.45, size = 1.8, stroke = 0) +
geom_line(linewidth = 1.1) +
labs(title = "Winter", x = expression(log[2]("Wetland Area")), y = NULL, color = "Trophic Level") +
scale_color_manual(values = okabe_ito, labels = trophcount_labels, drop = FALSE, na.translate = FALSE) +
scale_x_continuous(limits = xlim_abund) + scale_y_continuous(limits = ylim_abund) +
custom_theme+ labs(tag = "d") + tag_theme
combined_plot <- (
richWVtroph.s + richWVtroph.w + plot_spacer() + countWVtroph.s + countWVtroph.w
) +
plot_layout(ncol = 5, widths = c(1, 1, 0.05, 1, 1), guides = "collect") &
theme(
legend.position = "bottom",
legend.direction = "horizontal",
legend.title = element_text(size = 12),
legend.text  = element_text(size = 11)
)
# Save figure to Figures/
ggsave(here("Figures", "troph_A_combined_color.png"),
combined_plot, width = 1400/120, height = 500/120, dpi = 300, units = "in")
Anova(troph_rich_A.s, type = "3")
Anova(troph_rich_A.w, type = "3")
Anova(troph_count_A.s, type = "3")
Anova(troph_count_A.w, type = "3")
cite()
citation()
View(s.sparea.troph)
View(s.habitat)
source("~/GitHub/foundation-species/src/build_datasets.R")
source("~/GitHub/foundation-species/scripts/00_create_datasets.R")
# 2) trophic distributions
s.troph <- make_trophic_dist(s.habitat, s.indices)
w.troph <- make_trophic_dist(w.habitat, w.indices)
# long tables (names match your usage)
s.sparea.troph <- s.troph$richness
s.spcount.troph <- s.troph$count
s.spbio.troph  <- s.troph$biomass
w.sparea.troph <- w.troph$richness
w.spcount.troph <- w.troph$count
w.spbio.troph  <- w.troph$biomass
# 3) glm data with size classes (bin at 2 ha; adjust as needed)
s.glm.dat <- make_glm_dat(s.habitat, s.indices, size_breaks = c(0, 2, Inf))
w.glm.dat <- make_glm_dat(w.habitat, w.indices, size_breaks = c(0, 2, Inf))
# 4) functional diversity tables
s.f.dat <- make_functional_dat(s.habitat, s.indices)
# save these datasets for future use
suppressPackageStartupMessages({
library(readr)
library(fs)
library(jsonlite)
})
# 1) choose an output folder (dated for versioning)
OUT_ROOT <- "Data/derived"
STAMP    <- format(Sys.Date(), "%Y-%m-%d")  # e.g., 2025-09-18
OUT_DIR  <- file.path(OUT_ROOT, STAMP)
dir_create(OUT_DIR, recurse = TRUE)
rlang::last_trace()
# 4) functional diversity tables
s.f.dat <- make_functional_dat(s.habitat, s.indices)
source("~/GitHub/foundation-species/src/build_datasets.R")
# 4) functional diversity tables
s.f.dat <- make_functional_dat(s.habitat, s.indices)
w.f.dat <- make_functional_dat(w.habitat, w.indices)
# save these datasets for future use
suppressPackageStartupMessages({
library(readr)
library(fs)
library(jsonlite)
})
# 1) choose an output folder (dated for versioning)
OUT_ROOT <- "Data/derived"
STAMP    <- format(Sys.Date(), "%Y-%m-%d")  # e.g., 2025-09-18
OUT_DIR  <- file.path(OUT_ROOT, STAMP)
dir_create(OUT_DIR, recurse = TRUE)
# tiny helpers
write_csv_safe <- function(x, path, ...) {
# ensure data.frame/tibble + no rownames
if (!inherits(x, c("data.frame", "tbl_df"))) x <- as.data.frame(x)
write_csv(x, path, na = "", ...)
}
write_matrix_wide <- function(mat_or_df, path, rowname_as = "grid") {
df <- mat_or_df
# if object has rownames but no explicit grid column, promote rownames
rn <- rownames(df)
if (!is.null(rn) && !(rowname_as %in% names(df))) {
df <- cbind(!!rowname_as := rn, df)
}
# ensure plain data.frame for readr
df <- as.data.frame(df, stringsAsFactors = FALSE)
# put id column first
nm <- names(df); nm <- c(rowname_as, setdiff(nm, rowname_as)); df <- df[, nm, drop = FALSE]
write_csv_safe(df, path)
}
# 2) files to write (adjust to taste)
files <- list(
s_sparea_troph = list(obj = s.sparea.troph,  file = file.path(OUT_DIR, "summer_trophic_metrics.csv")),
w_sparea_troph = list(obj = w.sparea.troph,  file = file.path(OUT_DIR, "winter_trophic_metrics.csv"))
)
# 3) write CSVs
purrr::walk(files, function(x) {
obj <- x$obj; fp <- x$file
if (grepl("birds_.*_csv$", names(files)[which(vapply(files, identical, logical(1), x))])) {
# for community matrices keep first column as 'grid'
write_matrix_wide(obj, fp, rowname_as = "grid")
} else {
write_csv_safe(obj, fp)
}
})
# 5) simple manifest (what was written + basic dims)
manifest <- tibble::tibble(
file = basename(vapply(files, `[[`, "", "file")),
path = normalizePath(vapply(files, `[[`, "", "file"), winslash = "/"),
nrow = vapply(files, function(x) nrow(as.data.frame(x$obj)), integer(1)),
ncol = vapply(files, function(x) ncol(as.data.frame(x$obj)), integer(1))
)
write_json(manifest, file.path(OUT_DIR, "manifest.json"), pretty = TRUE, auto_unbox = TRUE)
message("✅ wrote derived datasets to: ", OUT_DIR)
